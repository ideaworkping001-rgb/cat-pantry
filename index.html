<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²“å’ªé£Ÿå ‚ V3.5.3</title>
    
    <style>
        body { background-color: #ffffff; color: #292524; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #debug-console {
            display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
            background: #fee2e2; border-bottom: 2px solid #ef4444; padding: 1rem;
            color: #b91c1c; font-family: monospace; font-size: 14px; white-space: pre-wrap;
            max-height: 50vh; overflow-y: auto;
        }
        .fab-transition { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .fab-transition:active { transform: scale(0.9); }
    </style>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var consoleDiv = document.getElementById('debug-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += 'âŒ éŒ¯èª¤ï¼š' + msg + '\n';
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.8/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.460.0?deps=react@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
</head>
<body>
    <div id="debug-console"></div>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Cat, Plus, Minus, History, Package, Trash2, Utensils, TrendingDown, 
            Settings, Check, Copy, Share2, X, Users, Camera, Loader2, 
            LayoutGrid, Image as ImageIcon, AlertCircle, Globe, ExternalLink, 
            MoreHorizontal, Sparkles, MessageSquare, Menu, Monitor, HelpCircle, 
            ArrowUpRight, Rocket, ChevronDown, ChevronUp, Tag, Edit3, ChevronRight,
            Maximize2, FolderInput, ArrowRightLeft, Scale, Info, Star, Award,
            Bath, Droplets, AlertTriangle, Stethoscope, BookOpen, UtensilsCrossed, Trophy
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, writeBatch } from 'firebase/firestore';

        // --- è¨­å®šå€ ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3XUohe5PtgBTJuwVGPmqf4xWxb_2odYw",
            authDomain: "hanaheyjude.firebaseapp.com",
            projectId: "hanaheyjude",
            storageBucket: "hanaheyjude.firebasestorage.app",
            messagingSenderId: "1096908110046",
            appId: "1:1096908110046:web:4b1c99468f0cbdfbdbea4f",
            measurementId: "G-MX6DZ3Q8GD"
        };
        const apiKey = ""; 

        let app, auth, db;
        const isConfigured = firebaseConfig && firebaseConfig.apiKey;
        if (isConfigured) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch(e) { console.error(e); }
        }

        const appId = 'standalone-app';
        const CATEGORIES = ['ä¸»é£Ÿç½', 'å‰¯é£Ÿç½', 'å‡ä¹¾', 'ä¹¾ä¹¾'];

        // --- è¼”åŠ©å‡½å¼ ---
        const resizeImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800; 
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                        else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.85)); 
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const analyzeImageWithGemini = async (base64Image) => {
            if (!apiKey) return null;
            try {
                const base64Data = base64Image.split(',')[1];
                const prompt = `åˆ†æé€™å¼µè²“é£Ÿç…§ç‰‡ã€‚è¾¨è­˜ã€Œå“ç‰Œã€(Brand)å’Œã€Œå“åã€(Name)ï¼Œå„ªå…ˆç”¨ç¹é«”ä¸­æ–‡ã€‚æ ¹æ“šåŒ…è£åˆ¤æ–·åˆ†é¡('ä¸»é£Ÿç½','å‰¯é£Ÿç½','ä¹¾ä¹¾','é›¶é£Ÿ/ä¿å¥')ã€‚å›å‚³JSON: { "brand": "...", "name": "...", "category": "..." }`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (error) { console.error("AI Error:", error); return null; }
        };

        const CategoryBadge = ({ category, className = "" }) => {
            const colors = { 'ä¸»é£Ÿç½': 'bg-blue-100 text-blue-800 border-blue-200', 'å‰¯é£Ÿç½': 'bg-orange-100 text-orange-800 border-orange-200', 'å‡ä¹¾': 'bg-amber-100 text-amber-800 border-amber-200', 'ä¹¾ä¹¾': 'bg-purple-100 text-purple-800 border-purple-200' };
            return <span className={`px-2 py-0.5 rounded-full text-[10px] font-medium border ${colors[category] || 'bg-gray-100'} ${className}`}>{category}</span>;
        };

        const StarRatingInput = ({ value, onChange, label }) => (
            <div className="flex flex-col items-center p-3 bg-stone-50 rounded-xl border border-stone-100">
                <span className="text-sm font-bold text-stone-600 mb-2">{label}</span>
                <div className="flex gap-2">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button key={star} type="button" onClick={() => onChange(star)} className="focus:outline-none transform active:scale-90 transition">
                            <Star className={`w-8 h-8 ${star <= value ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}`} />
                        </button>
                    ))}
                </div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-white rounded-3xl shadow-xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 max-h-[90vh] flex flex-col">
                        <div className="px-6 py-4 border-b border-stone-100 flex justify-between items-center bg-white flex-shrink-0">
                            <h3 className="font-bold text-stone-800 text-lg">{title}</h3>
                            <button onClick={onClose} className="p-2 bg-stone-100 rounded-full hover:bg-stone-200 transition"><X className="w-5 h-5 text-stone-500" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">{children}</div>
                    </div>
                </div>
            );
        };

        const ImageViewer = ({ src, onClose }) => {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[70] bg-black/95 flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white p-2 bg-white/10 backdrop-blur-md rounded-full hover:bg-white/20 transition"><X className="w-6 h-6" /></button>
                    <img src={src} className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
                </div>
            );
        };

        const Counter = ({ label, value, onChange, colorClass }) => (
            <div className="flex flex-col items-center p-3 bg-stone-50 rounded-xl border border-stone-100 hover:border-stone-200 transition h-full justify-center">
                <span className="text-xs text-stone-500 mb-2 font-bold">{label}</span>
                <div className="flex items-center gap-3">
                    <button onClick={() => onChange(Math.max(0, value - 1))} className="w-10 h-10 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-400 active:bg-stone-100 hover:shadow-sm transition"><Minus className="w-4 h-4" /></button>
                    <span className={`text-xl font-bold w-6 text-center ${value > 0 ? colorClass : 'text-stone-300'}`}>{value}</span>
                    <button onClick={() => onChange(value + 1)} className="w-10 h-10 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 active:bg-stone-100 hover:shadow-sm transition"><Plus className="w-4 h-4" /></button>
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [logs, setLogs] = useState([]);
            const [toiletLogs, setToiletLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            
            const [roomId, setRoomId] = useState(() => {
                if (window.location.hash.startsWith('#room=')) return window.location.hash.replace('#room=', '').trim();
                return localStorage.getItem('cat_pantry_room_id') || 'my-cats';
            });

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [tempRoomId, setTempRoomId] = useState(roomId);
            const [alertMessage, setAlertMessage] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [diaryFilter, setDiaryFilter] = useState('all');

            const [openCategory, setOpenCategory] = useState(null);
            const [openBrand, setOpenBrand] = useState(null);
            const [viewImage, setViewImage] = useState(null);

            const [deleteTarget, setDeleteTarget] = useState(null); 
            const [deleteLogTarget, setDeleteLogTarget] = useState(null); 
            const [deleteToiletTarget, setDeleteToiletTarget] = useState(null);
            const [editTarget, setEditTarget] = useState(null);
            const [moveBrandTarget, setMoveBrandTarget] = useState(null);
            const [ratingTarget, setRatingTarget] = useState(null);
            const [feedingTarget, setFeedingTarget] = useState(null);
            
            const [vomitTarget, setVomitTarget] = useState(null);
            const [vomitNote, setVomitNote] = useState('');

            const [newItemName, setNewItemName] = useState('');
            const [newItemBrand, setNewItemBrand] = useState('');
            const [newItemCategory, setNewItemCategory] = useState('ä¸»é£Ÿç½');
            const [newItemQuantity, setNewItemQuantity] = useState(1);
            const [newItemUnit, setNewItemUnit] = useState('ç½');
            const [newItemWeight, setNewItemWeight] = useState('');
            const [newItemImage, setNewItemImage] = useState('');
            const [isProcessingImage, setIsProcessingImage] = useState(false);
            
            const [editFormData, setEditFormData] = useState({ name: '', brand: '', category: 'ä¸»é£Ÿç½', unit: 'ç½', weight: '' });
            
            const [ratingHana, setRatingHana] = useState(0);
            const [ratingHeyJude, setRatingHeyJude] = useState(0);
            const [feedAmount, setFeedAmount] = useState('');

            const [urine, setUrine] = useState(0);
            const [poopNormal, setPoopNormal] = useState(0);
            const [poopBad, setPoopBad] = useState(0);

            const fileInputRef = useRef(null);

            const existingBrands = useMemo(() => {
                const brands = new Set(items.map(i => i.brand).filter(b => b && b.trim() !== ''));
                return Array.from(brands).sort();
            }, [items]);

            const getItemRatings = (itemName, brand) => {
                const itemLogs = logs.filter(l => l.foodName === itemName && l.brand === brand);
                if (itemLogs.length === 0) return null;
                const hanaAvg = itemLogs.filter(l => l.ratingHana > 0).reduce((a, b, i, arr) => a + b.ratingHana / arr.length, 0).toFixed(1);
                const heyJudeAvg = itemLogs.filter(l => l.ratingHeyJude > 0).reduce((a, b, i, arr) => a + b.ratingHeyJude / arr.length, 0).toFixed(1);
                return { hana: hanaAvg === "0.0" ? null : hanaAvg, heyJude: heyJudeAvg === "0.0" ? null : heyJudeAvg };
            };

            const favoriteFoods = useMemo(() => {
                if (logs.length === 0) return { hana: [], heyJude: [] };
                const processFavorites = (catName) => {
                    const scores = {};
                    logs.forEach(log => {
                        const rating = catName === 'hana' ? log.ratingHana : log.ratingHeyJude;
                        if (rating && rating > 0) {
                            const key = `${log.brand || ''} ${log.foodName}`;
                            if (!scores[key]) scores[key] = { total: 0, count: 0, name: key, category: log.category };
                            scores[key].total += rating;
                            scores[key].count += 1;
                        }
                    });
                    return Object.values(scores)
                        .map(item => ({ ...item, avg: item.total / item.count }))
                        .sort((a, b) => b.avg - a.avg || b.count - a.count);
                };
                return { hana: processFavorites('hana'), heyJude: processFavorites('heyJude') };
            }, [logs]);

            const allHistoryLogs = useMemo(() => {
                const foodLogsFormatted = logs.map(l => ({ ...l, type: 'food' }));
                const toiletLogsFormatted = toiletLogs.map(l => ({ ...l, type: l.type || 'cleaning' }));
                let filtered = [...foodLogsFormatted, ...toiletLogsFormatted];
                if (diaryFilter === 'food') filtered = foodLogsFormatted;
                else if (diaryFilter === 'toilet') filtered = toiletLogsFormatted.filter(l => l.type === 'cleaning');
                else if (diaryFilter === 'vomit') filtered = toiletLogsFormatted.filter(l => l.type === 'vomit');
                return filtered.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            }, [logs, toiletLogs, diaryFilter]);

            useEffect(() => {
                if (!auth) { setLoading(false); return; }
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (error) { console.error("Auth Error:", error); } };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                setLoading(true);
                const safeRoomId = roomId.trim().toLowerCase() || 'my-cats';
                const INVENTORY_COL = `room_${safeRoomId}_inventory`;
                const LOGS_COL = `room_${safeRoomId}_logs`;
                const TOILET_COL = `room_${safeRoomId}_toilet_logs`;

                const unsubItems = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', INVENTORY_COL), (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => {
                        if (a.category !== b.category) return a.category.localeCompare(b.category);
                        const brandA = a.brand || 'zz'; const brandB = b.brand || 'zz';
                        if (brandA !== brandB) return brandA.localeCompare(brandB);
                        return a.name.localeCompare(b.name);
                    });
                    setItems(data); setLoading(false);
                }, (err) => { console.error(err); setLoading(false); });

                const unsubLogs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', LOGS_COL), (snapshot) => {
                    setLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubToiletLogs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', TOILET_COL), (snapshot) => {
                    setToiletLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubItems(); unsubLogs(); unsubToiletLogs(); };
            }, [user, roomId]);

            const handleSwitchRoom = () => {
                if (!tempRoomId.trim()) return;
                const cleanId = tempRoomId.trim().toLowerCase();
                setRoomId(cleanId); localStorage.setItem('cat_pantry_room_id', cleanId);
                setIsSettingsOpen(false); setAlertMessage(`å·²åˆ‡æ›è‡³æˆ¿é–“ï¼š${cleanId}`);
                window.location.hash = `#room=${cleanId}`;
            };

            const handleTabChange = (tab) => { setActiveTab(tab); window.scrollTo({ top: 0, behavior: 'auto' }); };
            const handleImageSelect = async (e) => { const file = e.target.files?.[0]; if (file) { setIsProcessingImage(true); try { setNewItemImage(await resizeImage(file)); } catch (err) { setAlertMessage("åœ–ç‰‡è™•ç†å¤±æ•—"); } finally { setIsProcessingImage(false); } } };
            const handleSmartScan = async () => { if (!apiKey) { setAlertMessage("âš ï¸ è«‹å…ˆè¨­å®š Gemini API Key"); return; } if (!newItemImage) { setAlertMessage("è«‹å…ˆä¸Šå‚³ç…§ç‰‡"); return; } setIsScanning(true); const result = await analyzeImageWithGemini(newItemImage); if (result) { setNewItemName(result.name); if(result.brand) setNewItemBrand(result.brand); if (result.category) setNewItemCategory(result.category); setAlertMessage(`âœ¨ è¾¨è­˜æˆåŠŸï¼\nå“ç‰Œï¼š${result.brand || 'æœªçŸ¥'}\nå“åï¼š${result.name}\nåˆ†é¡ï¼š${result.category}`); } else { setAlertMessage("è¾¨è­˜å¤±æ•—"); } setIsScanning(false); };
            const handleAddItem = async (e) => { e.preventDefault(); if (!user || !newItemName) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`), { name: newItemName, brand: newItemBrand || '', category: newItemCategory, quantity: Number(newItemQuantity), unit: newItemUnit, weight: Number(newItemWeight) || 0, image: newItemImage || null, updatedAt: serverTimestamp() }); handleCancelAdd(); } catch (err) { setAlertMessage("æ–°å¢å¤±æ•—"); } };
            const handleCancelAdd = () => { setNewItemName(''); setNewItemBrand(''); setNewItemQuantity(1); setNewItemUnit('ç½'); setNewItemWeight(''); setNewItemImage(''); if (fileInputRef.current) fileInputRef.current.value = ''; setIsAddModalOpen(false); setActiveTab('inventory'); };
            const handleBrandMove = async (targetCategory) => { if (!user || !moveBrandTarget) return; const { brandName, currentCategory } = moveBrandTarget; const itemsToUpdate = items.filter(item => (item.brand === brandName || (!item.brand && brandName === 'å…¶ä»–å“ç‰Œ')) && item.category === currentCategory); try { const batch = writeBatch(db); itemsToUpdate.forEach(item => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`, item.id), { category: targetCategory, updatedAt: serverTimestamp() }); }); await batch.commit(); setMoveBrandTarget(null); setOpenBrand(null); } catch (err) { setAlertMessage("æ¬å®¶å¤±æ•—"); } };
            const handleEditClick = (item) => { setEditTarget(item); setEditFormData({ name: item.name, brand: item.brand || '', category: item.category, unit: item.unit, weight: item.weight || '' }); };
            const handleEditSave = async (e) => { e.preventDefault(); if (!user || !editTarget) return; try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`, editTarget.id), { name: editFormData.name, brand: editFormData.brand, category: editFormData.category, unit: editFormData.unit, weight: Number(editFormData.weight) || 0, updatedAt: serverTimestamp() }); setEditTarget(null); setAlertMessage("ä¿®æ”¹æˆåŠŸï¼"); } catch (err) { setAlertMessage("ä¿®æ”¹å¤±æ•—"); } };
            const confirmDelete = async () => { if (!user || !deleteTarget) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`, deleteTarget.id)); setDeleteTarget(null); } catch (err) { setAlertMessage("åˆªé™¤å¤±æ•—"); } };
            const confirmDeleteLog = async () => { if (!user || !deleteLogTarget) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_logs`, deleteLogTarget.id)); setDeleteLogTarget(null); } catch (err) { setAlertMessage("åˆªé™¤ç´€éŒ„å¤±æ•—"); } };
            const confirmDeleteToiletLog = async () => { if (!user || !deleteToiletTarget) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_toilet_logs`, deleteToiletTarget.id)); setDeleteToiletTarget(null); } catch (err) { setAlertMessage("åˆªé™¤å¤±æ•—"); } };
            const handleUpdateStock = async (item, change) => { try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`, item.id), { quantity: Math.max(0, item.quantity + change), updatedAt: serverTimestamp() }); } catch (err) { console.error(err); } };
            const handleFeedClick = (item) => { setFeedingTarget(item); setFeedAmount('1'); };
            const confirmFeed = async () => { if (!user || !feedingTarget || !feedAmount) return; const amount = parseFloat(feedAmount); if (isNaN(amount) || amount <= 0) { setAlertMessage("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡"); return; } const isFreezeDried = feedingTarget.category === 'å‡ä¹¾'; if (!isFreezeDried && feedingTarget.quantity < amount) { setAlertMessage(`åº«å­˜ä¸è¶³ï¼`); return; } try { const batch = writeBatch(db); if (!isFreezeDried) { batch.update(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_inventory`, feedingTarget.id), { quantity: feedingTarget.quantity - amount, updatedAt: serverTimestamp() }); } batch.set(doc(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_logs`)), { foodId: feedingTarget.id, foodName: feedingTarget.name, brand: feedingTarget.brand || '', category: feedingTarget.category, amount: amount, timestamp: serverTimestamp() }); await batch.commit(); setFeedingTarget(null); } catch (err) { setAlertMessage("é¤µé£Ÿç´€éŒ„å¤±æ•—"); } };
            const handleRatingClick = (log) => { setRatingTarget(log); setRatingHana(log.ratingHana || 0); setRatingHeyJude(log.ratingHeyJude || 0); };
            const handleRatingSave = async () => { if (!user || !ratingTarget) return; try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_logs`, ratingTarget.id), { ratingHana: ratingHana, ratingHeyJude: ratingHeyJude }); setRatingTarget(null); } catch (err) { setAlertMessage("è©•åˆ†å¤±æ•—"); } };
            const handleSaveCleaning = async () => { if (urine === 0 && poopNormal === 0 && poopBad === 0) { setAlertMessage("è«‹è‡³å°‘è¼¸å…¥ä¸€é …"); return; } try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_toilet_logs`), { type: 'cleaning', urineCount: urine, poopNormal, poopBad, timestamp: serverTimestamp() }); setUrine(0); setPoopNormal(0); setPoopBad(0); setAlertMessage("å·²ç´€éŒ„"); } catch (err) { setAlertMessage("å„²å­˜å¤±æ•—"); } };
            const handleVomitClick = (catName) => { setVomitTarget(catName); setVomitNote(''); };
            const handleConfirmVomit = async () => { if (!user || !vomitTarget) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomId}_toilet_logs`), { type: 'vomit', catName: vomitTarget, note: vomitNote, timestamp: serverTimestamp() }); setVomitTarget(null); setAlertMessage(`å·²ç´€éŒ„ï¼š${vomitTarget} å˜”å`); } catch (err) { setAlertMessage("å„²å­˜å¤±æ•—"); } };
            const formatTime = (timestamp) => { if (!timestamp) return 'å‰›å‰›'; const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp); return date.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }); };

            const renderInventory = () => {
                if (items.length === 0) return <div className="text-center py-12 bg-white rounded-xl shadow-sm border border-stone-100 text-stone-400">å°šç„¡åº«å­˜ï¼Œè«‹æ–°å¢ï¼</div>;
                return (
                    <div className="pb-20 space-y-3">
                        {CATEGORIES.map(cat => {
                            const catItems = items.filter(i => i.category === cat);
                            const isOpen = openCategory === cat;
                            const brandGroups = catItems.reduce((acc, item) => { const b = item.brand || 'å…¶ä»–å“ç‰Œ'; if(!acc[b]) acc[b] = []; acc[b].push(item); return acc; }, {});
                            const totalStock = catItems.reduce((acc, item) => acc + item.quantity, 0);
                            return (
                                <div key={cat} className="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden transition-all">
                                    <button onClick={() => { setOpenCategory(isOpen ? null : cat); setOpenBrand(null); }} className={`w-full flex items-center justify-between p-4 text-left transition-colors ${isOpen ? 'bg-orange-50 text-orange-900' : 'bg-white text-stone-700 hover:bg-stone-50'}`}>
                                        <div className="flex items-center gap-2"><span className="font-bold text-base">{cat}</span></div>
                                        <div className="flex items-center gap-2"><span className={`text-xs px-2 py-1 rounded-full font-bold ${totalStock > 0 ? 'bg-orange-200 text-orange-800' : 'bg-stone-100 text-stone-400'}`}>{totalStock}</span>{isOpen ? <ChevronUp className="w-4 h-4 text-stone-400" /> : <ChevronDown className="w-4 h-4 text-stone-400" />}</div>
                                    </button>
                                    {isOpen && (
                                        <div className="bg-stone-50 p-2 border-t border-stone-100 space-y-2">
                                            {Object.entries(brandGroups).map(([brand, bItems]) => {
                                                const isBrandOpen = openBrand === `${cat}-${brand}`;
                                                const brandStock = bItems.reduce((acc, item) => acc + item.quantity, 0);
                                                return (
                                                    <div key={brand} className="bg-white rounded-lg border border-stone-200 overflow-hidden">
                                                        <button onClick={() => setOpenBrand(isBrandOpen ? null : `${cat}-${brand}`)} className={`w-full flex items-center justify-between p-3 text-left transition-colors ${isBrandOpen ? 'bg-stone-100' : 'bg-white hover:bg-stone-50'}`}>
                                                            <div className="flex items-center gap-2"><div onClick={e => {e.stopPropagation(); setMoveBrandTarget({brandName: brand, currentCategory: cat});}} className="p-1 rounded-full hover:bg-stone-200 text-stone-400"><ArrowRightLeft className="w-4 h-4" /></div><Tag className="w-3 h-3 text-stone-400" /><span className="text-sm font-bold text-stone-700">{brand}</span></div>
                                                            <div className="flex items-center gap-2"><span className="text-xs text-stone-400 bg-stone-100 px-2 py-0.5 rounded-full">{brandStock}</span><ChevronRight className={`w-4 h-4 text-stone-400 transition-transform ${isBrandOpen ? 'rotate-90' : ''}`} /></div>
                                                        </button>
                                                        {isBrandOpen && (
                                                            <div className="p-3 border-t border-stone-100 space-y-3 bg-stone-50">
                                                                {bItems.map(item => {
                                                                    const ratings = getItemRatings(item.name, item.brand);
                                                                    return (
                                                                        <div key={item.id} className="bg-white rounded-xl p-3 shadow-sm border border-stone-100 flex flex-col gap-3">
                                                                            <div className="flex gap-3">
                                                                                <div className="w-20 h-20 bg-stone-50 rounded-lg flex-shrink-0 overflow-hidden border border-stone-100 flex items-center justify-center relative cursor-zoom-in group" onClick={() => item.image && setViewImage(item.image)}>{item.image ? <><img src={item.image} className="w-full h-full object-cover transition group-hover:scale-105" /><div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"><Maximize2 className="w-5 h-5 text-white drop-shadow-md" /></div></> : <Cat className="w-8 h-8 text-stone-300 opacity-30" />}</div>
                                                                                <div className="flex-1 min-w-0 flex flex-col justify-between">
                                                                                    <div className="flex justify-between items-start gap-2">
                                                                                        <div className="flex-1 min-w-0">
                                                                                            <h3 className="font-bold text-base text-stone-800 truncate">{item.name}</h3>
                                                                                            <div className="flex items-center gap-2 mt-1">
                                                                                                <span className="text-[10px] text-stone-400">{item.unit} {item.weight > 0 && `(${item.weight}g)`}</span>
                                                                                                {ratings && (<div className="flex gap-1 text-[10px]">{ratings.hana && <span className="text-pink-400">å“ˆâ˜…{ratings.hana}</span>}{ratings.heyJude && <span className="text-blue-400">é»‘â˜…{ratings.heyJude}</span>}</div>)}
                                                                                            </div>
                                                                                        </div>
                                                                                        <div className="flex gap-2 flex-shrink-0"><button onClick={() => handleEditClick(item)} className="text-stone-300 hover:text-blue-400 p-2 -mr-1 -mt-2"><Edit3 className="w-4 h-4" /></button><button onClick={() => setDeleteTarget(item)} className="text-stone-300 hover:text-red-400 p-2 -mr-2 -mt-2"><Trash2 className="w-4 h-4" /></button></div>
                                                                                    </div>
                                                                                    <div className="flex items-center justify-between mt-2">
                                                                                        <div className="flex items-center space-x-2"><button onClick={() => handleUpdateStock(item, -1)} className="w-7 h-7 flex items-center justify-center rounded-full bg-stone-50 text-stone-600"><Minus className="w-3 h-3" /></button><span className="text-lg font-bold w-6 text-center text-stone-700">{item.quantity}</span><button onClick={() => handleUpdateStock(item, 1)} className="w-7 h-7 flex items-center justify-center rounded-full bg-stone-50 text-stone-600"><Plus className="w-3 h-3" /></button></div>
                                                                                        <button onClick={() => handleFeedClick(item)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm transition active:scale-95 ${item.quantity > 0 || item.category === 'å‡ä¹¾' ? 'bg-orange-500 text-white hover:bg-orange-600' : 'bg-stone-100 text-stone-400'}`} disabled={item.quantity <= 0 && item.category !== 'å‡ä¹¾'}><Utensils className="w-3 h-3" /> {item.quantity <= 0 && item.category !== 'å‡ä¹¾' ? 'éœ€è£œè²¨' : 'é¤µé£Ÿ'}</button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        <button onClick={() => setIsAddModalOpen(true)} className="fixed bottom-24 right-4 w-14 h-14 bg-orange-500 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-orange-600 active:scale-95 transition z-40 fab-transition"><Plus className="w-8 h-8" /></button>
                    </div>
                );
            };

            const renderToilet = () => (
                <div className="space-y-6 animate-in fade-in">
                    <div className="bg-white rounded-xl shadow-sm border border-stone-100 p-4">
                        <h2 className="text-sm font-bold text-stone-800 mb-4 flex items-center gap-2"><Package className="w-4 h-4 text-blue-500" /> æ¯æ—¥æ¸…ç†ç´€éŒ„</h2>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2"><Counter label="ğŸ’§ å°¿å°¿" value={urine} onChange={setUrine} colorClass="text-blue-500"/></div>
                            <Counter label="ğŸ’© ä¾¿ä¾¿(æ­£å¸¸)" value={poopNormal} onChange={setPoopNormal} colorClass="text-stone-700"/>
                            <Counter label="ğŸ’© ä¾¿ä¾¿(ç•°å¸¸)" value={poopBad} onChange={setPoopBad} colorClass="text-red-500"/>
                        </div>
                        <button onClick={handleSaveCleaning} className="w-full mt-2 py-3 bg-blue-500 text-white rounded-xl font-bold shadow-md hover:bg-blue-600 active:scale-95 transition">ç´€éŒ„æ¸…ç†çµæœ</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-stone-100 p-4">
                        <h2 className="text-sm font-bold text-stone-800 mb-4 flex items-center gap-2"><AlertTriangle className="w-4 h-4 text-orange-500" /> å˜”åç´€éŒ„</h2>
                        <div className="flex gap-3">
                            <button onClick={() => handleVomitClick('å“ˆå¨œ')} className="flex-1 py-4 bg-pink-50 border border-pink-100 rounded-xl flex flex-col items-center gap-2 hover:bg-pink-100 transition active:scale-95"><span className="text-2xl">ğŸ¤®</span><span className="font-bold text-pink-600">å“ˆå¨œå˜”å</span></button>
                            <button onClick={() => handleVomitClick('é»‘å•¾')} className="flex-1 py-4 bg-blue-50 border border-blue-100 rounded-xl flex flex-col items-center gap-2 hover:bg-blue-100 transition active:scale-95"><span className="text-2xl">ğŸ¤®</span><span className="font-bold text-blue-600">é»‘å•¾å˜”å</span></button>
                        </div>
                    </div>
                </div>
            );

            const renderHistory = () => (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex justify-center mb-4"><div className="bg-stone-100 p-1 rounded-xl flex gap-1">
                        {['all', 'food', 'toilet', 'vomit'].map(f => (
                            <button key={f} onClick={() => setDiaryFilter(f)} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition ${diaryFilter === f ? 'bg-white text-stone-800 shadow-sm' : 'text-stone-400'}`}>
                                {f === 'all' ? 'å…¨éƒ¨' : f === 'food' ? 'é£²é£Ÿ' : f === 'toilet' ? 'å¦‚å»' : 'å˜”å'}
                            </button>
                        ))}
                    </div></div>
                    <h2 className="text-lg font-bold text-stone-700 px-1">ç´€éŒ„ ({roomId})</h2>
                    {allHistoryLogs.length === 0 ? <p className="text-center text-stone-400 py-10">ç„¡ç´€éŒ„</p> : 
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden divide-y divide-stone-100">
                            {allHistoryLogs.map((log) => {
                                if (log.type === 'food' || !log.type) {
                                    return (
                                        <div key={log.id} onClick={() => handleRatingClick(log)} className="p-4 flex justify-between items-center cursor-pointer hover:bg-stone-50 transition">
                                            <div className="mr-3 mt-1 self-start"><div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><UtensilsCrossed className="w-4 h-4"/></div></div>
                                            <div className="flex-1 min-w-0">
                                                <div className="mb-1.5">
                                                    {log.brand && <span className="text-stone-600 font-bold text-sm mr-1.5">{log.brand}</span>}
                                                    <span className="text-stone-800 font-bold text-sm">{log.foodName}</span>
                                                </div>
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <CategoryBadge category={log.category} className="scale-90 origin-left opacity-80"/>
                                                    <span className="text-xs text-stone-400 border-l border-stone-200 pl-2">{formatTime(log.timestamp)}</span>
                                                    {(log.ratingHana > 0 || log.ratingHeyJude > 0) && (
                                                        <div className="flex gap-2 ml-auto sm:ml-0">
                                                            {log.ratingHana > 0 && <div className="flex items-center gap-0.5 bg-pink-50 px-1.5 rounded text-[10px] text-pink-600"><span>å“ˆ</span><Star className="w-2.5 h-2.5 fill-pink-400 text-pink-400"/><span>{log.ratingHana}</span></div>}
                                                            {log.ratingHeyJude > 0 && <div className="flex items-center gap-0.5 bg-blue-50 px-1.5 rounded text-[10px] text-blue-600"><span>é»‘</span><Star className="w-2.5 h-2.5 fill-blue-400 text-blue-400"/><span>{log.ratingHeyJude}</span></div>}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3 pl-2">
                                                <span className="text-orange-600 font-bold bg-orange-50 px-2 py-1 rounded text-xs">-{log.amount}</span>
                                                <button onClick={(e) => { e.stopPropagation(); setDeleteLogTarget(log); }} className="text-stone-300 hover:text-red-400 p-1"><Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                    );
                                } else {
                                    return (
                                        <div key={log.id} className="p-4 flex justify-between items-start bg-stone-50/50 hover:bg-stone-100 transition">
                                            <div className="flex gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-1 ${log.type === 'vomit' ? 'bg-orange-100 text-orange-500' : 'bg-blue-100 text-blue-500'}`}>{log.type === 'vomit' ? 'ğŸ¤®' : <Bath className="w-4 h-4" />}</div>
                                                <div className="flex-1">
                                                    {log.type === 'vomit' ? (
                                                        <div>
                                                            <div className="font-bold text-sm text-stone-800 mb-1">{log.catName} å˜”å</div>
                                                            {log.note && <div className="text-xs text-stone-500 bg-white border border-stone-200 p-2 rounded-lg">{log.note}</div>}
                                                        </div>
                                                    ) : (
                                                        <div>
                                                            <div className="font-bold text-sm text-stone-800 mb-1">æ¯æ—¥æ¸…ç†</div>
                                                            <div className="flex flex-wrap gap-1 text-[10px] font-bold text-stone-500">
                                                                {(log.urineCount || 0) > 0 && <span className="bg-blue-50 px-1 rounded">ğŸ’§å°¿å°¿ {log.urineCount}</span>}
                                                                {(log.urineSmall || 0) > 0 && <span className="bg-blue-100 px-1 rounded">ğŸ’§å°å°¿ {log.urineSmall}</span>}
                                                                {(log.urineLarge || 0) > 0 && <span className="bg-blue-200 px-1 rounded text-blue-700">ğŸ’§å¤§å°¿ {log.urineLarge}</span>}
                                                                {(log.poopNormal || 0) > 0 && <span className="bg-stone-100 px-1 rounded">ğŸ’©ä¾¿ä¾¿ {log.poopNormal}</span>}
                                                                {(log.poopBad || 0) > 0 && <span className="bg-red-50 text-red-600 px-1 rounded">ğŸ’©ç•°å¸¸ {log.poopBad}</span>}
                                                            </div>
                                                        </div>
                                                    )}
                                                    <div className="text-xs text-stone-400 mt-1">{formatTime(log.timestamp)}</div>
                                                </div>
                                            </div>
                                            <button onClick={() => setDeleteToiletTarget(log)} className="text-stone-300 hover:text-red-400 p-1 mt-1"><Trash2 className="w-4 h-4" /></button>
                                        </div>
                                    );
                                }
                            })}
                        </div>
                    }
                </div>
            );

            if (!isConfigured) return <div className="min-h-screen flex items-center justify-center p-6 bg-stone-50"><div className="text-center max-w-md bg-white p-8 rounded-2xl shadow-lg border border-red-100"><AlertCircle className="w-12 h-12 text-red-500 mx-auto mb-4" /><h1 className="text-xl font-bold text-stone-800 mb-2">å°šæœªè¨­å®šè³‡æ–™åº«</h1><p className="text-stone-500 text-sm leading-relaxed mb-6">è«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ firebaseConfig æ˜¯å¦æ­£ç¢ºå¡«å…¥ã€‚</p></div></div>;
            if (loading && !items.length) return <div className="min-h-screen bg-stone-50 flex items-center justify-center"><Loader2 className="w-10 h-10 text-orange-400 animate-spin" /></div>;

            return (
                <div className="min-h-screen bg-stone-50 text-stone-800 font-sans pb-24 relative overflow-hidden">
                    <ImageViewer src={viewImage} onClose={() => setViewImage(null)} />
                    <header className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 rounded-full border overflow-hidden">
                                    <img src="001.png" alt="Logo" className="w-full h-full object-cover" onError={(e) => {e.target.onerror=null; e.target.src='https://placekitten.com/100/100'}} /> 
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold text-stone-800 leading-none flex items-center gap-1">å“ˆå¨œé»‘å•¾ï½œç”Ÿæ´»ç´€éŒ„</h1>
                                    <span className="text-[10px] text-stone-400 font-mono">æˆ¿é–“: {roomId}</span>
                                </div>
                            </div>
                            <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="text-xs flex items-center gap-1 px-3 py-1.5 rounded-full bg-stone-100 hover:bg-stone-200 transition"><Users className="w-3 h-3 text-stone-500" /><span className="font-bold">ç™»å…¥</span></button>
                        </div>
                        {isSettingsOpen && (
                            <div className="max-w-md mx-auto px-4 pb-4">
                                <div className="bg-stone-50 p-4 border rounded-xl">
                                    <label className="text-xs font-bold block mb-1">æˆ¿é–“ä»£ç¢¼</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={tempRoomId} onChange={e => setTempRoomId(e.target.value)} className="border p-2 rounded flex-1" />
                                        <button onClick={handleSwitchRoom} className="bg-stone-800 text-white px-4 rounded">é€²å…¥</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-md mx-auto p-4">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
                                    <h2 className="text-sm font-bold text-stone-800 mb-4 flex items-center gap-2"><Award className="w-4 h-4 text-yellow-500" /> å£å‘³å–œå¥½æ’è¡Œæ¦œ</h2>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-4">
                                            <div className="flex items-center gap-2 text-xs font-bold text-stone-500 border-b border-stone-100 pb-1"><div className="w-2 h-2 rounded-full bg-pink-400"></div> å“ˆå¨œ</div>
                                            {favoriteFoods.hana.length > 0 ? favoriteFoods.hana.map((item, idx) => (
                                                <div key={idx} className="mb-3">
                                                    <div className="text-xs font-medium truncate text-stone-500">{idx+1}. {item.name}</div>
                                                    <div className="flex items-center gap-1 text-xs text-stone-400 mt-1"><Star className="w-3 h-3 fill-yellow-400 text-yellow-400" /> <span>{item.avg.toFixed(1)}</span> <span className="text-stone-300 ml-1">({item.count}æ¬¡)</span></div>
                                                </div>
                                            )) : <div className="text-[10px] text-stone-300 italic">å°šç„¡è©•åˆ†</div>}
                                        </div>
                                        <div className="space-y-4">
                                            <div className="flex items-center gap-2 text-xs font-bold text-stone-500 border-b border-stone-100 pb-1"><div className="w-2 h-2 rounded-full bg-blue-400"></div> é»‘å•¾</div>
                                            {favoriteFoods.heyJude.length > 0 ? favoriteFoods.heyJude.map((item, idx) => (
                                                <div key={idx} className="mb-3">
                                                    <div className="text-xs font-medium truncate text-stone-500">{idx+1}. {item.name}</div>
                                                    <div className="flex items-center gap-1 text-xs text-stone-400 mt-1"><Star className="w-3 h-3 fill-yellow-400 text-yellow-400" /> <span>{item.avg.toFixed(1)}</span> <span className="text-stone-300 ml-1">({item.count}æ¬¡)</span></div>
                                                </div>
                                            )) : <div className="text-[10px] text-stone-300 italic">å°šç„¡è©•åˆ†</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeTab === 'inventory' && renderInventory()}
                        {activeTab === 'toilet' && renderToilet()}
                        {activeTab === 'history' && renderHistory()}
                    </main>

                    {/* Modals */}
                    <Modal isOpen={!!deleteTarget} onClose={() => setDeleteTarget(null)} title="ç¢ºèªåˆªé™¤">
                        <div className="text-center mb-4">ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteTarget?.name}ã€å—ï¼Ÿ</div>
                        <div className="flex gap-3"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-2 bg-stone-100 rounded-xl font-bold">å–æ¶ˆ</button><button onClick={confirmDelete} className="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold">åˆªé™¤</button></div>
                    </Modal>

                    <Modal isOpen={!!deleteLogTarget} onClose={() => setDeleteLogTarget(null)} title="åˆªé™¤ç´€éŒ„">
                        <div className="text-center mb-4">ç¢ºå®šè¦åˆªé™¤é€™ç­†é£²é£Ÿç´€éŒ„å—ï¼Ÿ</div>
                        <div className="flex gap-3"><button onClick={() => setDeleteLogTarget(null)} className="flex-1 py-2 bg-stone-100 rounded-xl font-bold">å–æ¶ˆ</button><button onClick={confirmDeleteLog} className="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold">åˆªé™¤</button></div>
                    </Modal>

                    <Modal isOpen={!!deleteToiletTarget} onClose={() => setDeleteToiletTarget(null)} title="åˆªé™¤ç´€éŒ„">
                        <div className="text-center mb-4">ç¢ºå®šè¦åˆªé™¤é€™ç­†å¦‚å»ç´€éŒ„å—ï¼Ÿ</div>
                        <div className="flex gap-3"><button onClick={() => setDeleteToiletTarget(null)} className="flex-1 py-2 bg-stone-100 rounded-xl font-bold">å–æ¶ˆ</button><button onClick={confirmDeleteToiletLog} className="flex-1 py-2 bg-red-500 text-white rounded-xl font-bold">åˆªé™¤</button></div>
                    </Modal>

                    <Modal isOpen={!!feedingTarget} onClose={() => setFeedingTarget(null)} title="é¤µé£Ÿç¢ºèª">
                        <div className="space-y-4">
                            <div className="text-center font-bold text-lg">{feedingTarget?.brand} {feedingTarget?.name}</div>
                            {feedingTarget?.category === 'å‡ä¹¾' && <div className="text-xs text-blue-500 bg-blue-50 p-2 rounded">å‡ä¹¾ä¸æ‰£åº«å­˜</div>}
                            <div className="flex gap-2"><input type="number" step="0.1" value={feedAmount} onChange={e => setFeedAmount(e.target.value)} className="flex-1 border p-2 rounded text-center text-xl" /></div>
                            <div className="grid grid-cols-4 gap-2">{[0.5, 1, 1.5, 2].map(v => <button key={v} onClick={() => setFeedAmount(String(v))} className="bg-stone-100 py-1 rounded">{v}</button>)}</div>
                            <button onClick={confirmFeed} className="w-full bg-orange-500 text-white py-3 rounded font-bold">ç¢ºèª</button>
                        </div>
                    </Modal>

                    <Modal isOpen={!!moveBrandTarget} onClose={() => setMoveBrandTarget(null)} title="å“ç‰Œæ¬å®¶">
                         <div className="grid grid-cols-1 gap-2">
                            {CATEGORIES.filter(c => c !== moveBrandTarget?.currentCategory).map(cat => (
                                <button key={cat} onClick={() => handleBrandMove(cat)} className="w-full py-3 bg-stone-100 rounded font-bold">ç§»å‹•åˆ° {cat}</button>
                            ))}
                         </div>
                    </Modal>

                    <Modal isOpen={!!ratingTarget} onClose={() => setRatingTarget(null)} title="å£å‘³è©•åˆ†">
                        <div className="space-y-4">
                            <StarRatingInput label="å“ˆå¨œ (Hana)" value={ratingHana} onChange={setRatingHana} />
                            <StarRatingInput label="é»‘å•¾ (HeyJude)" value={ratingHeyJude} onChange={setRatingHeyJude} />
                            <button onClick={handleRatingSave} className="w-full py-3 bg-stone-800 text-white rounded-xl">å„²å­˜</button>
                        </div>
                    </Modal>

                    <Modal isOpen={!!editTarget} onClose={() => setEditTarget(null)} title="ç·¨è¼¯å“é …">
                        <form onSubmit={handleEditSave} className="space-y-4">
                            <input type="text" value={editFormData.brand} onChange={e => setEditFormData({...editFormData, brand: e.target.value})} className="w-full border p-2 rounded" placeholder="å“ç‰Œ" />
                            <input type="text" value={editFormData.name} onChange={e => setEditFormData({...editFormData, name: e.target.value})} className="w-full border p-2 rounded" placeholder="å“å" required />
                            <div className="flex gap-2">
                                <select value={editFormData.category} onChange={e => setEditFormData({...editFormData, category: e.target.value})} className="border p-2 rounded flex-1">{CATEGORIES.map(c => <option key={c}>{c}</option>)}</select>
                                <select value={editFormData.unit} onChange={e => setEditFormData({...editFormData, unit: e.target.value})} className="border p-2 rounded w-1/3"><option>ç½</option><option>åŒ…</option><option>ç›’</option><option>æ¢</option><option>g</option></select>
                            </div>
                            <div className="flex gap-2 items-center border p-2 rounded">
                                <label className="text-xs text-stone-500 whitespace-nowrap">é‡é‡(g):</label>
                                <input type="number" value={editFormData.weight} onChange={e => setEditFormData({...editFormData, weight: e.target.value})} className="w-full outline-none" placeholder="é¸å¡«" />
                            </div>
                            <button type="submit" className="w-full bg-orange-500 text-white p-3 rounded-xl font-bold hover:bg-orange-600 transition">å„²å­˜</button>
                        </form>
                    </Modal>
                    
                    <Modal isOpen={isAddModalOpen} onClose={handleCancelAdd} title="æ–°å¢åº«å­˜">
                         <form onSubmit={handleAddItem} className="space-y-5">
                            <div className="relative w-full h-56 bg-stone-100 rounded-2xl border-2 border-dashed border-stone-200 flex flex-col items-center justify-center overflow-hidden cursor-pointer hover:border-orange-300 transition group" onClick={() => fileInputRef.current.click()}>
                                {newItemImage ? (
                                    <>
                                        <img src={newItemImage} className="w-full h-full object-cover" />
                                        <div className="absolute inset-0 bg-black/20 group-hover:bg-black/30 transition" />
                                        <button type="button" onClick={(e) => {e.stopPropagation(); setNewItemImage('');}} className="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full backdrop-blur-md hover:bg-red-500 transition"><X className="w-4 h-4"/></button>
                                        <button type="button" onClick={(e) => {e.stopPropagation(); handleSmartScan();}} disabled={isScanning} className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur text-stone-800 px-4 py-2 rounded-full shadow-lg font-bold text-sm flex items-center gap-2 hover:scale-105 transition">
                                            {isScanning ? <Loader2 className="w-4 h-4 animate-spin"/> : <Sparkles className="w-4 h-4 text-purple-500"/>}
                                            <span>AI ç‡Ÿé¤Šè¾¨è­˜</span>
                                        </button>
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center text-stone-400 group-hover:text-orange-400 transition">
                                        <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-3"><Camera className="w-8 h-8" /></div>
                                        <span className="font-bold text-sm">æ‹æ”æˆ–ä¸Šå‚³ç…§ç‰‡</span>
                                    </div>
                                )}
                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageSelect} />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-stone-400 ml-1">å“ç‰Œ</label>
                                <input type="text" value={newItemBrand} onChange={e => setNewItemBrand(e.target.value)} className="w-full px-4 py-3 bg-stone-50 rounded-xl border-none focus:ring-2 focus:ring-orange-100 outline-none font-bold text-stone-700" placeholder="ä¾‹å¦‚ï¼šæ±ªå–µæ˜Ÿçƒ" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-stone-400 ml-1">å“é …åç¨±</label>
                                <input type="text" value={newItemName} onChange={e => setNewItemName(e.target.value)} className="w-full px-4 py-3 bg-stone-50 rounded-xl border-none focus:ring-2 focus:ring-orange-100 outline-none font-bold text-stone-700" placeholder="ä¾‹å¦‚ï¼šé›è‚‰é¤" required />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-stone-400 ml-1">åˆ†é¡</label>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                    {CATEGORIES.map(cat => (
                                         <button key={cat} type="button" onClick={() => setNewItemCategory(cat)} className={`flex-1 py-3 px-2 rounded-xl font-bold text-sm transition-all ${newItemCategory === cat ? 'bg-orange-500 text-white shadow-lg' : 'bg-stone-50 text-stone-400'}`}>{cat}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1 space-y-2">
                                    <label className="text-xs font-bold text-stone-400 ml-1">æ•¸é‡</label>
                                    <div className="flex items-center justify-between bg-stone-50 rounded-xl p-1.5 border border-stone-100">
                                        <button type="button" onClick={() => setNewItemQuantity(Math.max(0, newItemQuantity - 1))} className="w-10 h-10 bg-white rounded-lg shadow-sm text-stone-500 flex items-center justify-center"><Minus className="w-4 h-4"/></button>
                                        <input type="number" value={newItemQuantity} onChange={(e) => setNewItemQuantity(Number(e.target.value))} className="w-full bg-transparent text-center font-bold text-xl outline-none" />
                                        <button type="button" onClick={() => setNewItemQuantity(newItemQuantity + 1)} className="w-10 h-10 bg-white rounded-lg shadow-sm text-stone-500 flex items-center justify-center"><Plus className="w-4 h-4"/></button>
                                    </div>
                                </div>
                                <div className="w-1/3 space-y-2">
                                    <label className="text-xs font-bold text-stone-400 ml-1">å–®ä½ & å…‹æ•¸</label>
                                    <div className="flex flex-col gap-2">
                                        <select value={newItemUnit} onChange={(e) => setNewItemUnit(e.target.value)} className="w-full h-10 px-2 bg-stone-50 rounded-xl border border-stone-100 font-bold text-stone-600 outline-none text-center text-sm"><option>ç½</option><option>åŒ…</option><option>ç›’</option><option>æ¢</option><option>g</option></select>
                                        <input type="number" value={newItemWeight} onChange={(e) => setNewItemWeight(e.target.value)} className="w-full h-10 px-2 bg-stone-50 rounded-xl border border-stone-100 font-bold text-stone-600 outline-none text-center text-sm" placeholder="å…‹æ•¸(g)" />
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button type="button" onClick={handleCancelAdd} className="flex-1 py-3 bg-stone-100 text-stone-500 rounded-xl font-bold">å–æ¶ˆ</button>
                                <button type="submit" disabled={isProcessingImage} className="flex-[2] py-3 bg-orange-500 text-white rounded-xl font-bold shadow-lg">ç¢ºèªæ–°å¢</button>
                            </div>
                         </form>
                    </Modal>

                    <Modal isOpen={!!vomitTarget} onClose={() => setVomitTarget(null)} title={`è¨˜éŒ„${vomitTarget}å˜”å`}>
                        <div className="space-y-4">
                            <textarea className="w-full p-3 border rounded-xl h-32" placeholder="è«‹è¼¸å…¥å˜”åç‹€æ³ (é¸å¡«)" value={vomitNote} onChange={(e) => setVomitNote(e.target.value)} />
                            <button onClick={handleConfirmVomit} className="w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-md">ç¢ºèªç´€éŒ„</button>
                        </div>
                    </Modal>

                    <Modal isOpen={!!alertMessage} onClose={() => setAlertMessage(null)} title="æç¤º">
                        <div className="text-center mb-4">{alertMessage}</div>
                        <button onClick={() => setAlertMessage(null)} className="w-full bg-stone-800 text-white p-2 rounded-xl font-bold">OK</button>
                    </Modal>

                    <nav className="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 pb-safe z-30">
                        <div className="max-w-md mx-auto w-full flex justify-around">
                            <button onClick={() => handleTabChange('dashboard')} className={`flex flex-col items-center p-2 transition w-1/4 ${activeTab === 'dashboard' ? 'text-orange-600' : 'text-stone-400'}`}><Trophy className="w-6 h-6"/><span className="text-[10px]">æ’è¡Œæ¦œ</span></button>
                            <button onClick={() => handleTabChange('inventory')} className={`flex flex-col items-center p-2 transition w-1/4 ${activeTab === 'inventory' ? 'text-orange-600' : 'text-stone-400'}`}><UtensilsCrossed className="w-6 h-6"/><span className="text-[10px]">é£²é£Ÿ</span></button>
                            <button onClick={() => handleTabChange('toilet')} className={`flex flex-col items-center p-2 transition w-1/4 ${activeTab === 'toilet' ? 'text-orange-600' : 'text-stone-400'}`}><Bath className="w-6 h-6"/><span className="text-[10px]">éŸå±</span></button>
                            <button onClick={() => handleTabChange('history')} className={`flex flex-col items-center p-2 transition w-1/4 ${activeTab === 'history' ? 'text-orange-600' : 'text-stone-400'}`}><BookOpen className="w-6 h-6"/><span className="text-[10px]">ç´€éŒ„</span></button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>